---
title: "Graphics for Communication"
session: "03"
subtitle: "R Markdown for Medicine"
author: Alison Hill
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: ["default", "assets/css/my-theme.css", "assets/css/my-fonts.css"]
    seal: false 
    lib_dir: libs
    nature:
      highlightStyle: dracula
      highlightLanguage: ["r", "yaml", "markdown"]
      slideNumberFormat: "" 
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
      beforeInit: "https://platform.twitter.com/widgets.js"
    includes:
      in_header: assets/header.html  
params:
  palette: berlin
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(countdown)
library(tidyverse)
library(scico)
library(cowplot)
library(ymlthis)
ggplot2::theme_set(ggplot2::theme_minimal())
```

```{r load-data, include=FALSE}
mockdata_all <- read_csv(here::here("static/mockpaper/data/mockdata.csv")) %>% 
  mutate_at(vars(starts_with("ae_")), ~as.factor(.)) %>% 
  mutate(fu_fct = fct_recode(as.factor(fu_stat), 
                             "Lived" = "1", 
                             "Died" = "2"))  

# see my note below re: sites
mockdata <- mockdata_all %>% 
  filter(!site == "Nur-Sultan")

source('figs.R')
```


class: title-slide, center, middle

<span class="fa-stack fa-4x">
  <i class="fa fa-circle fa-stack-2x" style="color: #ffffffcc;"></i>
  <strong class="fa-stack-1x" style="color:#3b4245;">`r rmarkdown::metadata$session`</strong>
</span> 

# `r rmarkdown::metadata$title`

## `r rmarkdown::metadata$subtitle`

### `r rmarkdown::metadata$author` &#183; RStudio

#### [rmd4medicine.netlify.com/](https://rmd4medicine.netlify.com/)


---
layout: true

<div class="my-footer"><span>https://rstd.io/rmd4medicine-cloud</span></div>


---
exclude: true

at this point, we should be within a bookdown with html and word doc output options?

Or an rticles with bookdown under the hood?

---
class: inverse, middle


.pull-left[

```{r echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/rstudio/hex-stickers/master/PNG/ggplot2.png")
```

]

--

.pull-right[

[`ggplot2` package](https://ggplot2.tidyverse.org/)

[`ggplot2` cheatsheet](https://github.com/rstudio/cheatsheets/blob/master/data-visualization-2.1.pdf)

[R4DS chapter](https://r4ds.had.co.nz/data-visualisation.html)

]

---
class: middle, center, inverse

<span class="fa-stack fa-4x">
  <i class="fa fa-circle fa-stack-2x" style="color: #fff;"></i>
  <strong class="fa-stack-1x" style="color:#2f5275;">1</strong>
</span> 

# Get figures in

---
class: your-turn

# Your turn: Part 1 of 3

A warm-up exercise! Open `03-draft.Rmd`. It has 4 figures coded using the `ggplot2` package.

1. Knit the document to the `bookdown::html_document2` format &mdash; behold!

1. Add output options to this format to use one of the [bootswatch themes](https://rmarkdown.rstudio.com/docs/reference/html_document.html) and include a [floating table of contents](https://rmarkdown.rstudio.com/docs/reference/html_document.html#floating-table-of-contents).

1. Knit to `bookdown::word_document2` (no options)- how does it look?

__If this was easy__, add `distill::distill_article` as an output format (consider adding a TOC too) and knit- what differences do you see between this and the `bookdown::html_document2` format?

_psst...next slide has answers..._

```{r echo=FALSE}
countdown(minutes = 5)
```


---
class: your-turn

# Answer

.pull-left[
```{r echo = FALSE}
yml_empty() %>% 
  yml_output(bookdown::html_document2(theme = "flatly", toc = TRUE, toc_float = TRUE),
             bookdown::word_document2(),
             distill::distill_article(toc = TRUE)) %>% 
  asis_yaml_output()
```
]

.pull-right[
````
```{r setup, include=FALSE}`r ''`
knitr::opts_chunk$set(
  echo = TRUE,
  warning = TRUE,
  message = TRUE,
  comment = "##",
  R.options = list(width = 60)
)
```
````

]

Distill is much less chatty than other outputs due to default `knitr` code chunk options: https://rstudio.github.io/distill/basics.html#code-blocks

---
class: middle, center

```{r fig.show="hold", out.width='25%', echo = FALSE, fig.retina=3}
age_histogram
surv_pct_plot
surv_days_plot
ae_pct_plot
```

???

so, how did we get a figure into R Markdown?

Answer: it has to print!

---
class: your-turn

# Your turn: Part 2 of 3

Now go through `03-draft-revised.Rmd` and read through the "Note to Peter" at the top. It now has 5 figures coded using the `ggplot2` package.

.pull-left[

```{r eval=FALSE}
# demographics?
# maybe combine into a multi-panel plot?
age_density
age_boxplot

# treatment response? another multi-panel?
surv_pct_plot
surv_days_plot

# adverse events?
ae_pct_plot
```
]

.pull-right[
1. Add new code chunks containing plots you wish to include where you want them to go in the document.

1. Edit the code chunk options as you need to.
]

```{r echo=FALSE}
countdown(minutes = 5)
```
---

# Chunk options


https://yihui.name/knitr/options/#plots




---

That is where we are going

How are we going to get there?

First, we need to learn about how to include a single plot in your article.

EASY JUST MAKE & KNIT!

---

But sometimes it doesn't look quite right. 

- fig resolution
- fig size

---

```{r echo=FALSE}
library(ggbeeswarm)
surv_bee <- ggplot(mockdata) +
  aes(x = arm, 
      y = fu_time, 
      fill = arm, 
      group = interaction(arm,fu_fct)) +
  geom_quasirandom(alpha = 0.3, 
              colour = "black", 
              dodge.width = .9) +
  geom_boxplot(width = .3, 
               outlier.shape = NA, 
               na.rm = TRUE, 
               position = position_dodge(width = .9)) +
  labs(y= "Survival Time in \nDays (Censored)", x = "Study Arm") +
  scale_fill_scico_d(palette = 'lapaz', 
                     guide = FALSE, 
                     begin = .3, 
                     end = .8)
```




---
class: live-code

# Live code demo

We take the first plot and together we:

1. Label the chunk

1. Add a figure caption _(watch what happens if we don't label it first!)_

1. Align figure to the right, center



---

first introduce `knitr::include_graphics` for static images

---


.pull-left[

```{r age-hist, fig.show='hide'}
age_histogram <- 
  ggplot(mockdata, aes(age)) +
  geom_histogram(color = 'white',
                 fill = scico::scico(1, 
                                     begin = .3, 
                                     palette = params$palette),
                 bins = 20) +
  labs(x = "Age", 
       y = "Count") +
  scale_y_continuous(
    breaks = scales::pretty_breaks()
  )
age_histogram
```

]

.pull-right[
```{r ref.label='age-hist', echo=FALSE}

```

]

---

.pull-left[

````
```{r}`r ''`
age_histogram
```
````

```{r ref.label='age-hist', echo=FALSE}

```
]

--

.pull-right[

````
```{r fig.retina=3}`r ''`
age_histogram
```
````

```{r ref.label='age-hist', echo=FALSE, fig.retina=3, out.height="50%"}

```
]

---

now you have to 
1. label the chunk
1. add `fig.cap` 

```{r ref.label='age-hist', echo=FALSE, fig.cap="Age histogram"}

```

???

You must label the chunk for the figure caption to show up

---

# Caption a figure

.pull-left[

````
```{r pressure-plot, fig.cap='Look!'}`r ''`
plot(pressure, type = 'b', pch = 19)
```
````

]

.pull-right[
.center[

```{r pressure-plot, out.width='75%', echo = FALSE, fig.retina = 3}
plot(pressure, type = 'b', pch = 19)
```

**Fig. 1:** Look!]

]

---

# Cross-reference a figure

.pull-left[

See Figure `\@ref(fig:pressure-plot)`.

````
```{r pressure-plot}`r ''`
plot(pressure, type = 'b', pch = 19)
```
````

]

.pull-right[

See Figure [1](https://skeleton-bookdown.netlify.com/intro.html).

.center[

```{r ref.label = 'pressure-plot', out.width='75%', echo = FALSE, fig.retina = 3}
```

]

]

---

# Figure references

for static images

`knitr::include_graphics`


---
class: your-turn

# Your turn

take one of the plots in the doc, add some `knitr` chunk options to it to:

1. Add a chunk label
1. Increase the figure resolution
1. Add a figure caption
1. _If this was easy, try to change the figure alignment (and its caption) to the center._

```{r echo=FALSE}
countdown(minutes = 3)
```

---
class: middle, center, inverse

<span class="fa-stack fa-4x">
  <i class="fa fa-circle fa-stack-2x" style="color: #fff;"></i>
  <strong class="fa-stack-1x" style="color:#2f5275;">2</strong>
</span> 

# Combine figures in output

---

do multi-panel here

`cowplot` for multi-panel plots

---
class: live-code

# Live code demo

We combine `age_density` and `age_boxplot` with the `cowplot` package.

```{r fig.retina=3, fig.asp=.5, out.width="70%", fig.align='center'}
plot_grid(age_density, age_boxplot, labels = "AUTO")
```


---
class: your-turn

# Your turn

## Make a plot grid

1. Combine `surv_pct_plot` and `surv_days_plot` with the `cowplot` package.

1. Label the chunk and be sure you set up you `fig.path` correctly.

1. Knit to determine the best chunk options for `fig.retina`, `fig.asp`, and `out.width`


_psst...my answers on the next slide..._

```{r echo=FALSE}
countdown(minutes = 5)
```

---
class: your-turn

# Answers

````
```{r echo = FALSE, fig.retina=3, fig.asp=.5, fig.width=20}`r ''`
plot_grid(surv_pct_plot, surv_days_plot, labels = "AUTO")
```
````

```{r echo = FALSE, fig.retina=3, fig.asp=.5, fig.width=10, fig.align='center'}
plot_grid(surv_pct_plot, surv_days_plot, labels = "AUTO")
```


---

# Cross-references to figures

Once you have:

`r emo::ji("heavy_check_mark")` A labeled chunk that produces a plot

`r emo::ji("heavy_check_mark")` A figure caption using `fig.cap`

Then you can have:

## Cross-references! 


---
class: live-code

# Live code demo

We take the first plot and together we:

1. Add an in-text reference to the figure using `\@ref(fig:age-dist)`

1. Knit and behold



---
class: middle, center, inverse

<span class="fa-stack fa-4x">
  <i class="fa fa-circle fa-stack-2x" style="color: #fff;"></i>
  <strong class="fa-stack-1x" style="color:#2f5275;">3</strong>
</span> 

# Get figures out

---

# Exporting plots

cover ggsave for outputting figures

```{r eval=FALSE}
ggsave()
```


---

setting `fig.path` as a code chunk option

---
class: live-code

# Live code demo

We take the first plot and together we:

1. Add `fig.path="figs/"` as a `knitr` code chunk option _(watch what happens if we don't include the backslash!)_

1. Knit and behold

---
class: your-turn

# Your turn: Add figure path to setup chunk

Remember our old friend, the `knitr` setup chunk? 

1. Add `fig.path="figs/"` to the *global* setup chunk

1. Save and knit- what do you notice?

```{r echo=FALSE}
countdown(minutes = 2)
```


---

`knitr` options for controlling size (https://r4ds.had.co.nz/graphics-for-communication.html#figure-sizing)

---

graphics type output (https://r4ds.had.co.nz/graphics-for-communication.html#other-important-options)

---
`knitr` options for fig resolution

---
class: middle, center

# Change your mental model

.pull-left[

### Content = presentation

```{r echo=FALSE}
knitr::include_graphics("images/word.png")
```

]

.pull-right[

### Content &rarr; presentation

]

---
class: middle, center

# `r emo::ji("stopwatch")`

# Time for a break!

```{r echo = FALSE}
countdown(minutes = 10, update_every = 15)
```



